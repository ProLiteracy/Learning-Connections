---
title: "Occupation Filter Engine"
author: "Jamison R. Crawford"
date: "May 2, 2017"
output: html_document
---

ENGINE INSTRUCTIONS: This document has a series of mandatory steps for running the filtering engine, as well as some optional bits and bobs. Once you've filtered occupations according to the criteria in "STEP IV", you can quickly export the document to your working directory.

Each grey strip, called a "code chunk", contains a series of code which has been divided very deliberately to perform different functions. You can run entire chunks by selecting the green play button in the upper-right corner of each. Most output is suppressed, but don't be suprised if the RStudio console (in the lower-left pane) expands, in which case you can just watch the magic happen.

Most steps require you to simply run the code chunk. However, some include warnings and special notes - you'll want to read these. Some include background information, which provides a deeper understanding of what happens in each chunk. Have fun!



STEP I: INSTALL PACKAGES

*WARNING: If you've already run this chunk of code, try to avoid running it again unless you have difficulty loading packages in "STEP II". If you happen to run this code, it simply reinstalls packages - in this case, simply select "No" for "Updating Loaded Packages" prompts. 

*NOTE: Your organization may have a proxy or firewall which precludes you from running this chunk and, therefore, using the tool - in this case, try speaking with your IT staff to find a workaround, or you can simply run this on a personal laptop or home desktop computer.

INSTRUCTIONS: Run the following code chunk ONCE. You should not have to rerun it in the future, as these packages should remain installed. Each time you reopen the tool, however, you will have to load these packages into the environment (see "STEP II").


```{r Install Packages, include=FALSE, echo=FALSE }

#-------------------- Install Packages

install.packages( "readr" )
install.packages( "dplyr" )
install.packages( "ggplot2" )
install.packages( "scales" )

```



STEP II: IMPORT DATA, LOAD PACKAGES, AND CREATE UNIQUE SUBSETS

INSTRUCTIONS: Run code chunk.

BACKGROUND: Running code chunk loads the above-installed packages necessary for reading in data from Github, manipulating the data, and visualizing filtered output. It also creates individual datasets with legends for filtering data in "STEP IV" and creates a dataset with a legend for comparing occupation archetype titles to unique identiers, called "O*NET-SOC Codes".


```{r Import Data & Create Subsets, message=FALSE, echo=FALSE, warning=FALSE, include=FALSE }

#-------------------- Load Packages

library( readr )
library( dplyr )
library( ggplot2 )
library( scales )


#-------------------- Import CSVs

Descriptions <- 
  read_csv("https://raw.githubusercontent.com/ProLiteracy/Learning-Connections/master/Datasets/Occupation%20Data.csv")
Background <- 
  read_csv("https://raw.githubusercontent.com/ProLiteracy/Learning-Connections/master/Datasets/Education%2C%20Training%2C%20and%20Experience.csv")
Categories <- 
  read_csv("https://raw.githubusercontent.com/ProLiteracy/Learning-Connections/master/Datasets/Education%2C%20Training%2C%20and%20Experience%20Categories.csv")
Zones <- 
  read_csv("https://raw.githubusercontent.com/ProLiteracy/Learning-Connections/master/Datasets/Job%20Zones.csv")


#-------------------- Cutomize Background Category Legends

Categories_Ed <- filter( Categories , `Scale ID` == "RL" )
Categories_Ex <- filter( Categories , `Scale ID` == "RW" )
Categories_Ost <- filter( Categories , `Scale ID` == "PT" )
Categories_Ojt <- filter( Categories , `Scale ID` == "OJ" )


#-------------------- Create O*NET-SOC Code & Title Legend

SOC <- select( Descriptions , `O*NET-SOC Code` , Title )

```



(OPTIONAL) REMOVE RECOMMENDED SUPPRESSIONS 

*WARNING: Running this chunk may remove valuable occupations from filter output. If you wish to revert data to include items recommended for suppression, simply rerun the above code chunk in "STEP II".

BACKGROUND: Occupations are recommended for suppression when considered "low precision" according to the O*NET 21.2 Database; "low precision" may indicate a small sampel size of reporting incumbents (n), low variance, or large relative standard errors.


```{r Suppress Recommended, echo=FALSE, include=FALSE }

Background <- filter( Background , `Recommend Suppress` == "N" )

```



STEP III: MANIPULATE "Background" DATASET

INSTRUCTIONS: Run code chunk.

BACKGROUND: Run this code chunk to manipulate the clean the "Background" dataset. Because most O*NET data uses the same variable in different datasets, we can give those variables unique IDs here.


```{r Background Data, echo=FALSE, include=FALSE }

#-------------------- Cleaning "Background" Data

Background <- filter( Background , `Data Value` != 0 ) # Remove Rows with 0% of Incumbent Votes
Background <- select( Background , `O*NET-SOC Code` , `Element ID` , `Element Name` , `Scale ID` , Category , `Data Value` )


#-------------------- Make New, Unique Column Names & Remove Old

Background <- Background %>% mutate( `Background ID` = `Element ID` )
Background <- Background %>% mutate( `Background Element` = `Element Name` ) 
Background <- Background %>% mutate( `Background Scale` = `Scale ID` ) 
Background <- Background %>% mutate( `Background Category` = `Category` )
Background <- Background %>% mutate( `Background Value` = `Data Value` )
Background <- select( Background , 
                      `O*NET-SOC Code` , 
                      `Background ID` , 
                      `Background Element` , 
                      `Background Scale` , 
                      `Background Category` , 
                      `Background Value` )

```




(OPTIONAL) VIEW CATEGORIES

BACKGROUND: Running this code chunk will open four tabs, each containing legends for the education, related work experience, on-site, and on-job training categories. These inform the next code chunk, where you can modify these categories to filter your output. If you only want to open one legend, click on the line of code in this chunk and type "ctrl + r".


```{r View Categories, echo=FALSE }

View( Categories_Ed )
View( Categories_Ex )
View( Categories_Ost )
View( Categories_Ojt )

```



STEP IV: ASSIGN CATEGORY & PERCENTAGE LIMITS

INSTRUCTIONS: This is the part where you can choose criteria. ONLY edit the numbers - they will be assigned to variables and run in the next code chunk. Run this code chunk when you have modified the numbers according to the desired criteria. The percentage theshold indicates the maximum allowed percentage of reporting incumbents (on which this data is based) which fall into the maximum category you've defined.

EXAMPLE: If you cap education ("ed") at "6" (Bachelor's degree) and a maximum percentage at "30" (30%), this means that any occupation in which at least 30% of incumbents have a Bachelor's degree will not be filtered and, therefore, will be included in output. Higher percentages are more discriminant.

*NOTE: You must rerun this code chunk each time you change criteria.


```{r Assign Criteria Values, include=FALSE }

# Education

"ed" <- 6 # Maximum Category ( Must be Number Between 1-12 )
"edp" <- 90 # Maximum Percentage Threshold ( Must be integer between 0-100 )

# Related Experience

"ex" <- 6 # Maximum Category ( Must be Number Between 1-11 )
"exp" <- 75 # Maximum Percentage Threshold ( Must be integer between 0-100 )

# On-Site Training

"ost" <- 5 # Maximum Category ( Must be Number Between 1-9 )
"ostp" <- 75 # Maximum Percentage Threshold ( Must be integer between 0-100 )

# On-the-Job Training

"ojt" <- 5 # Maximum Category ( Must be Number Between 1-9 )
"ojtp" <- 75 # Maximum Percentage Threshold ( Must be integer between 0-100 )

```



STEP V: CREATE, FILTER, & VISUALIZE SUBSETS

INSTRUCTIONS: Run code chunk.

BACKGROUND: This code chunk creates new data subsets filtered according to your criteria in "STEP IV". It then creates a rudimentary visualization of the total number of filtered jobs by eligbility category (e.g. "education").

*NOTE: You must rerun this code chunk each time you change criteria in "STEP IV"


```{r Produce Summary, echo=FALSE }


#-------------------- Background Education

Background_Ed <- filter( Background , 
                         `Background Scale` == "RL" , # Filters only "Education" Scale
                         `Background Category` <= ed ) # Removes Educational Background greater than or equal to "ed"

Background_Ed <- Background_Ed %>%
  group_by( `O*NET-SOC Code` ) %>% 
  mutate( "Edp_Total" = sum( `Background Value` ) ) # Creates new column ("Edp_Total") totaling "Background Value" for each SOC Code

Background_Ed <- filter( Background_Ed ,
                         Edp_Total >= edp ) # Removes occupations not greater than or equal to threshold "edp"

Background_Ed <- select( Background_Ed , 
                         `O*NET-SOC Code` , 
                         `Edp_Total`) # Reduce columns to SOC Codes and Total Percentage within Threshold

Background_Ed <- unique( Background_Ed ) # Remove duplicate rows


#-------------------- Background Work Experience

Background_Ex <- filter( Background , 
                         `Background Scale` == "RW" , # Filters only "Related Work Experience" Scale
                         `Background Category` <= ex ) # Filters Related Work Experience less than or equal to "ex"

Background_Ex <- Background_Ex %>%
  group_by( `O*NET-SOC Code` ) %>% 
  mutate( "Exp_Total" = sum( `Background Value` ) ) # Creates new column ("Exp_Total") totaling "Background Value" for each SOC Code

Background_Ex <- filter( Background_Ex ,
                         Exp_Total >= exp ) # Removes occupations not greater than or equal to threshold "exp"

Background_Ex <- select( Background_Ex , 
                         `O*NET-SOC Code` , 
                         `Exp_Total`) # Reduce columns to SOC Codes, Background Scale, and Total Percentage within Threshold

Background_Ex <- unique( Background_Ex ) # Remove duplicate rows


#-------------------- Background On-Site Training

Background_Ost <- filter( Background , 
                         `Background Scale` == "PT" , # Filters only "On-Site Training" Scale
                         `Background Category` <= ost ) # Filters On-Site Training less than or equal to "ost"

Background_Ost <- Background_Ost %>%
  group_by( `O*NET-SOC Code` ) %>% 
  mutate( "Ostp_Total" = sum( `Background Value` ) ) # Creates new column ("Ostp_Total") totaling "Background Value" for each SOC Code

Background_Ost <- filter( Background_Ost ,
                         Ostp_Total >= ostp ) # Removes occupations not greater than or equal to threshold "ostp"

Background_Ost <- select( Background_Ost , 
                         `O*NET-SOC Code` , 
                         `Ostp_Total`) # Reduce columns to SOC Codes, Background Scale, and Total Percentage within Threshold

Background_Ost <- unique( Background_Ost ) # Remove duplicate rows


#-------------------- Background On-the-Job Training

Background_Ojt <- filter( Background , 
                         `Background Scale` == "OJ" , # Filters only "On-the-Job Training" Scale
                         `Background Category` <= ojt ) # Filters On-the-Job Training less than or equal to "ojt"

Background_Ojt <- Background_Ojt %>%
  group_by( `O*NET-SOC Code` ) %>% 
  mutate( "Ojtp_Total" = sum( `Background Value` ) ) # Creates new column ("Ojtp_Total") totaling "Background Value" for each SOC Code

Background_Ojt <- filter( Background_Ojt ,
                         Ojtp_Total >= ojtp ) # Removes occupations not greater than or equal to threshold "ojtp"

Background_Ojt <- select( Background_Ojt , 
                          `O*NET-SOC Code` , 
                          `Ojtp_Total`) # Reduce columns to SOC Codes, Background Scale, and Total Percentage within Threshold

Background_Ojt <- unique( Background_Ojt ) # Remove duplicate rows


#-------------------- Create Summary Dataframe of Eligible Jobs by Category

Elig_Ed <- merge( Background_Ed , SOC )
Elig_Ex <- merge( Background_Ex , SOC )
Elig_Ost <- merge( Background_Ost , SOC )
Elig_Ojt  <- merge( Background_Ojt , SOC ) # Attaches titles to eligible occupations by category

Uniq_Back <- select( Background , 
                     `O*NET-SOC Code` ) %>%
  unique() # Retrieves unique occupations in "Background"


#-------------------- Create Eligibility Dataframe According to Category

Category <- c( "Education" , 
               "Experience" , 
               "On-Site Training" , 
               "On-Job Training" )
Frequency <- c( nrow( Elig_Ed ) , 
                nrow( Elig_Ex) , 
                nrow( Elig_Ost ) , 
                nrow( Elig_Ojt ) )
Elig_Sum <- data_frame( Category , 
                        Frequency ) %>%
  mutate( "Proportion" = percent( Frequency / nrow( Uniq_Back ) ) ) %>%
  as.data.frame() # Creates categories, frequency in categories, and proportin of total


#-------------------- Plot Eligiblity Summary by Category

ggplot( Elig_Sum , aes( x = Category , y = Frequency , col = Proportion , fill = Proportion ) ) +
  geom_bar( stat = "identity" ) +
  ggtitle( "Filtered Occupations by Category" ) +
  labs( x = "Category" , y = "Occupations per Category" ) +
  theme( panel.background = element_blank() , legend.position = "none" ) +
  coord_flip() +
  geom_text( label = paste( Elig_Sum$Frequency, " (" , Elig_Sum$Proportion , ")" , sep = "" ) , 
             position = "identity" , hjust = -.25 ) +
  ylim( 0 , max( Elig_Sum$Frequency ) * 1.3 ) # Plot Filtered Occupations by Category (Education, Experience, On-Site/On-Job Training)

```



STEP VI: FILTER & PRODUCE SUMMARY

INSTRUCTIONS: Run code chunk.

BACKGROUND: This code chunk combines occupations filtered by category into a single dataset, removing occupations that do not meet all eight criteria in all four "Background" dimensions, and matches them with their occupation archetype titles according to their O*NET-SOC Codes. Lastly, it creates rudimentary visualizations of the total filtered occupations output and into which "Job Zones" they fall (a ranking of 1 to 5 indicating degree of professional development required), the total number of filtered jobs by eligbility category, and a list of filtered occupation titles and their "Job Zones".

*NOTE: You must rerun this code chunk each time you change criteria.


```{r Background Data, echo=FALSE }

#-------------------- Merge Common Occupations

Background_Eligible <- merge( Background_Ed , Background_Ex , by = "O*NET-SOC Code" )
Background_Eligible <- merge( Background_Eligible , Background_Ost , by = "O*NET-SOC Code" )
Background_Eligible <- merge( Background_Eligible , Background_Ojt , by = "O*NET-SOC Code" )

Eligible_Title_Scales <- merge( Background_Eligible , SOC , by = "O*NET-SOC Code" )
Eligible_Titles <- select( Eligible_Title_Scales , `O*NET-SOC Code` , Title )
Eligible_Titles <- merge( Eligible_Titles , Zones )
Eligible_Titles <- select( Eligible_Titles , `O*NET-SOC Code` , Title , `Job Zone` )
Eligible_Titles <- Eligible_Titles[ order( Eligible_Titles$`Job Zone` ) , ]


#-------------------- Create Filter Summary Information

Summary <- Eligible_Titles %>%
  mutate( "Total" = nrow( Eligible_Titles) ) %>%
  group_by( `Job Zone` ) %>%
  mutate( "Occupations" = n() ,
          "Zone" = `Job Zone` ) %>%
  ungroup( `Job Zone` ) %>%
  select( Zone , 
          Occupations , 
          Total ) %>%
  mutate( "Proportion" = percent( Occupations / Total ) ) %>%
  unique() %>% as.data.frame()


#-------------------- Plot & Print Summary Information

ggplot( Summary , aes( x = Zone , y = Occupations , col = Proportion , fill = Proportion ) ) +
  geom_bar( stat = "identity" ) +
  ggtitle( paste( "Filtered:" , 
                  Summary$Total , "Occupations", sep = " " ) ) +
  labs( x = "Job Zone" , y = "Total Occupations per Zone" ) +
  theme( panel.background = element_blank() , legend.position = "none" ) +
  coord_flip() +
  geom_text( label = paste( Summary$Occupations, " (" , Summary$Proportion , ")" , sep = "" ) , 
             position = "identity" , hjust = -.25 ) +
  ylim( 0 , max( Summary$Occupations ) * 1.3 ) # Plot Summary of Occupations by Job Zone

print( paste( "(Zone " , Eligible_Titles$`Job Zone` , ") " , Eligible_Titles$Title , sep = "" ) ) # Print Eligible Titles

```



(OPTIONAL) VIEW "Eligible Titles" DATAFRAME

BACKGROUND: Running this code chunk will open the newly filtered dataset into a new tab, sorted according to "Job Zones", and much easier to view, filter, or perform text-based searches.


```{r View Eligible Titles, message=FALSE, warning=FALSE , echo=FALSE }

View( Eligible_Titles )

```



(OPTIONAL) LOCALLY EXPORT "Eligible Titles" TO EXCEL

INSTRUCTIONS: This code chunk will export the newly filtered dataset into an Excel spreadsheet in .CSV format to your working directory - you can use the defualt "Eligible Occupations" or change the name of your file by rewriting the text in the first line of code below. After running the code, you will receive a confirmation message with the location of your new spreadsheet.

*NOTE: You can change your working directory in the top menu by clicking "Session" > "Set Working Directory"


```{r Export to Excel, echo=FALSE, message=FALSE, warning=FALSE}

file <- "Eligible Occupations" # Write the name of your file in these quotations; do not end name with ".xlsx" or ".csv"

file <- paste( file , "csv" , sep = "." )
write_csv( Eligible_Titles , file )
print( noquote( paste( "Awesome! The file " , "'" , file , "'" , " has been export to " , "'" , getwd() , "'" , sep = "" ) ) )

```
